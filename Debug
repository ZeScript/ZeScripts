--[[Ohhh you little skidder think your so cool dont ye? anyhow this is used so that we know if the script works or not if we get no new messages about someone using the script then we know there is a problem cool? cool.]]

-- Authentication Check
local function verifyAuthentication()
	local expectedAuthKey = "DOORS_SCRIPT_V1_AUTH_2024"
	local expectedVersion = "1.0.0"
	local expectedSource = "OFFICIAL_LOADER"

	if _G.AUTH_KEY ~= expectedAuthKey or
	   _G.SCRIPT_VERSION ~= expectedVersion or
	   _G.AUTHORIZED_SOURCE ~= expectedSource then
		game:GetService("Players").LocalPlayer:Kick("Real script: https://rscripts.net/script/zescript-doors-8M38")
		return false
	end

	return true
end

if not verifyAuthentication() then
	return
end

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Wait for LocalPlayer
local player = Players.LocalPlayer
if not player then
	Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
	player = Players.LocalPlayer
end

-- URLs
local webhookUrl = "https://discord.com/api/webhooks/1444415194716573797/6tyoftw9Pa2QzHkZcj3AocZEl7if6QYtvxAFAbN71ecq83aEiKCWZP9VEzmkcPM-JdUK"
local googleScriptUrl = "https://script.google.com/macros/s/AKfycbzuazVi52P5OM_typNE82ZvG83gjKa1wRNFqbZctKOUNWfZkAMbL408azjDgy-6f9o8XA/exec"

-- Detect executor
local function getExecutor()
	local executor = "Unknown"
	
	-- Check common executor identifiers
	if identifyexecutor then
		executor = identifyexecutor() or "Unknown"
	elseif KRNL_LOADED then
		executor = "KRNL"
	elseif syn then
		executor = "Synapse X"
	elseif SENTINEL_LOADED then
		executor = "Sentinel"
	elseif getexecutorname then
		executor = getexecutorname() or "Unknown"
	elseif is_sirhurt_closure then
		executor = "SirHurt"
	elseif Fluxus then
		executor = "Fluxus"
	elseif iselectron then
		executor = "Electron"
	elseif OXYGEN_LOADED then
		executor = "Oxygen U"
	elseif TRIGON_LOADED then
		executor = "Trigon"
	elseif getrenv().DrawingImmediate then
		executor = "Solara"
	elseif PROTOSMASHER_LOADED then
		executor = "ProtoSmasher"
	elseif pebc_execute then
		executor = "ProtoSmasher"
	elseif SCRIPT_WARE_LOADED then
		executor = "Script-Ware"
	elseif ARCEUS_LOADED then
		executor = "Arceus X"
	elseif Unit then
		executor = "Unit"
	elseif isvm then
		executor = "Proxo"
	elseif shadowify then
		executor = "Shadow"
	elseif isfile and isfolder then
		-- Additional check for some executors
		if isfile("workspace/fluxus.txt") then
			executor = "Fluxus"
		elseif isfile("workspace/synapse.txt") then
			executor = "Synapse X"
		end
	end
	
	return executor
end

-- Get player information
local function getPlayerInfo()
	local info = {
		Username = player.Name,
		DisplayName = player.DisplayName,
		UserId = player.UserId,
		AccountAge = player.AccountAge,
		GameName = "Unknown Game",
		GameId = game.PlaceId,
		ExecutorTime = os.date("%Y-%m-%d %H:%M:%S"),
		JobId = game.JobId,
		Executor = getExecutor()
	}
	
	-- Try to get game name
	pcall(function()
		info.GameName = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name
	end)
	
	return info
end

-- Update Google Sheets and get execution count
local function updateExecutionCount()
	local executionCount = 1
	local isNewUser = true
	
	local success, result = pcall(function()
		local data = {
			userId = player.UserId,
			username = player.Name
		}
		
		local response = request({
			Url = googleScriptUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json"
			},
			Body = HttpService:JSONEncode(data)
		})
		
		if response.StatusCode == 200 then
			local responseData = HttpService:JSONDecode(response.Body)
			if responseData.success then
				executionCount = responseData.executionCount
				isNewUser = responseData.isNewUser
			end
		end
	end)
	
	if not success then
		warn("Failed to update Google Sheets:", result)
	end
	
	return executionCount, isNewUser
end

-- Calculate session time
local sessionStart = tick()
local function getSessionTime()
	local elapsed = tick() - sessionStart
	local minutes = math.floor(elapsed / 60)
	local seconds = math.floor(elapsed % 60)
	return string.format("%dm %ds", minutes, seconds)
end

-- Send chat message webhook
local function sendChatWebhook(message)
	pcall(function()
		local info = getPlayerInfo()
		
		local data = {
			["embeds"] = {{
				["title"] = "üí¨ Chat Message Logged",
				["description"] = "User sent a message in chat",
				["color"] = 3447003, -- Blue color
				["fields"] = {
					{
						["name"] = "üë§ Username",
						["value"] = "`" .. info.Username .. "`",
						["inline"] = true
					},
					{
						["name"] = "üÜî User ID",
						["value"] = "`" .. tostring(info.UserId) .. "`",
						["inline"] = true
					},
					{
						["name"] = "‚öôÔ∏è Executor",
						["value"] = "**" .. info.Executor .. "**",
						["inline"] = true
					},
					{
						["name"] = "üí≠ Message",
						["value"] = "```" .. message .. "```",
						["inline"] = false
					},
					{
						["name"] = "üéÆ Game",
						["value"] = info.GameName,
						["inline"] = true
					},
					{
						["name"] = "‚è∞ Time",
						["value"] = info.ExecutorTime,
						["inline"] = true
					}
				},
				["thumbnail"] = {
					["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. info.UserId .. "&width=150&height=150&format=png"
				},
				["footer"] = {
					["text"] = "Chat Logger ‚Ä¢ " .. info.Executor
				},
				["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
			}}
		}
		
		local jsonData = HttpService:JSONEncode(data)
		
		request({
			Url = webhookUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json"
			},
			Body = jsonData
		})
	end)
end

-- Monitor chat messages (New TextChatService)
local function setupNewChatMonitoring()
	pcall(function()
		local textChannels = TextChatService:WaitForChild("TextChannels")
		local generalChannel = textChannels:WaitForChild("RBXGeneral")
		
		generalChannel.MessageReceived:Connect(function(message)
			if message.TextSource and message.TextSource.UserId == player.UserId then
				sendChatWebhook(message.Text)
			end
		end)
	end)
end

-- Monitor chat messages (Legacy Chat)
local function setupLegacyChatMonitoring()
end

-- Send webhook notification
local function sendWebhook(executionCount, isNewUser)
	local success, err = pcall(function()
		local info = getPlayerInfo()
		
		-- Determine user status
		local userStatus = isNewUser and "üÜï **NEW USER**" or "üîÑ **RETURNING USER**"
		local embedColor = isNewUser and 3066993 or 5814783 -- Green for new, Purple for returning
		
		local data = {
			["embeds"] = {{
				["title"] = "üöÄ Script Executed",
				["description"] = "A user has executed your script!\n" .. userStatus,
				["color"] = embedColor,
				["fields"] = {
					{
						["name"] = "üë§ Username",
						["value"] = "`" .. info.Username .. "`",
						["inline"] = true
					},
					{
						["name"] = "‚ú® Display Name",
						["value"] = "`" .. info.DisplayName .. "`",
						["inline"] = true
					},
					{
						["name"] = "üÜî User ID",
						["value"] = "`" .. tostring(info.UserId) .. "`",
						["inline"] = true
					},
					{
						["name"] = "‚öôÔ∏è Executor",
						["value"] = "**" .. info.Executor .. "**",
						["inline"] = true
					},
					{
						["name"] = "üìä Total Executions",
						["value"] = "**" .. tostring(executionCount) .. "** time" .. (executionCount > 1 and "s" or ""),
						["inline"] = true
					},
					{
						["name"] = "üìÖ Account Age",
						["value"] = info.AccountAge .. " days",
						["inline"] = true
					},
					{
						["name"] = "‚≠ê User Type",
						["value"] = isNewUser and "First Time!" or "Repeat User",
						["inline"] = true
					},
					{
						["name"] = "üéÆ Game",
						["value"] = info.GameName,
						["inline"] = false
					},
					{
						["name"] = "üî¢ Game ID",
						["value"] = "`" .. tostring(info.GameId) .. "`",
						["inline"] = true
					},
					{
						["name"] = "üåê Server JobId",
						["value"] = "`" .. info.JobId:sub(1, 20) .. "...`",
						["inline"] = true
					},
					{
						["name"] = "‚è∞ Execution Time",
						["value"] = info.ExecutorTime,
						["inline"] = true
					},
					{
						["name"] = "üìä Session Status",
						["value"] = "üü¢ **Active** (Just Started) | üí¨ **Chat Monitoring: ON**",
						["inline"] = false
					}
				},
				["thumbnail"] = {
					["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. info.UserId .. "&width=150&height=150&format=png"
				},
				["footer"] = {
					["text"] = "Script Logger ‚Ä¢ Execution #" .. executionCount .. " ‚Ä¢ " .. info.Executor
				},
				["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
			}}
		}
		
		local jsonData = HttpService:JSONEncode(data)
		
		request({
			Url = webhookUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json"
			},
			Body = jsonData
		})
	end)
	
	if not success then
		warn("Webhook failed:", err)
	end
end

-- Send session end notification
local function sendSessionEnd(executionCount)
	pcall(function()
		local info = getPlayerInfo()
		local sessionTime = getSessionTime()
		
		local data = {
			["embeds"] = {{
				["title"] = "‚èπÔ∏è Session Ended",
				["description"] = info.Username .. " has stopped using the script",
				["color"] = 15158332, -- Red color
				["fields"] = {
					{
						["name"] = "üë§ User",
						["value"] = "`" .. info.Username .. "` (" .. info.UserId .. ")",
						["inline"] = true
					},
					{
						["name"] = "‚è±Ô∏è Session Duration",
						["value"] = sessionTime,
						["inline"] = true
					},
					{
						["name"] = "‚öôÔ∏è Executor",
						["value"] = "**" .. info.Executor .. "**",
						["inline"] = true
					},
					{
						["name"] = "üìä Total Executions",
						["value"] = "**" .. tostring(executionCount) .. "** times",
						["inline"] = true
					},
					{
						["name"] = "üéÆ Game",
						["value"] = info.GameName,
						["inline"] = false
					}
				},
				["thumbnail"] = {
					["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. info.UserId .. "&width=150&height=150&format=png"
				},
				["footer"] = {
					["text"] = "Script Logger ‚Ä¢ Session Ended ‚Ä¢ " .. info.Executor
				},
				["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
			}}
		}
		
		local jsonData = HttpService:JSONEncode(data)
		
		request({
			Url = webhookUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json"
			},
			Body = jsonData
		})
	end)
end

-- Send heartbeat every 5 minutes
local lastHeartbeat = tick()
local executionCount = 1

game:GetService("RunService").Heartbeat:Connect(function()
	if tick() - lastHeartbeat >= 300 then -- 5 minutes
		lastHeartbeat = tick()
		pcall(function()
			local info = getPlayerInfo()
			local sessionTime = getSessionTime()
			
			local data = {
				["embeds"] = {{
					["title"] = "üíö Still Active",
					["description"] = info.Username .. " is still using the script",
					["color"] = 5763719, -- Green color
					["fields"] = {
						{
							["name"] = "üë§ User",
							["value"] = "`" .. info.Username .. "`",
							["inline"] = true
						},
						{
							["name"] = "‚è±Ô∏è Session Time",
							["value"] = sessionTime,
							["inline"] = true
						},
						{
							["name"] = "‚öôÔ∏è Executor",
							["value"] = "**" .. info.Executor .. "**",
							["inline"] = true
						},
						{
							["name"] = "üìä Total Executions",
							["value"] = "**" .. tostring(executionCount) .. "** times",
							["inline"] = true
						},
						{
							["name"] = "üéÆ Game",
							["value"] = info.GameName,
							["inline"] = false
						}
					},
					["thumbnail"] = {
						["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. info.UserId .. "&width=150&height=150&format=png"
					},
					["footer"] = {
						["text"] = "Script Logger ‚Ä¢ Heartbeat ‚Ä¢ " .. info.Executor
					},
					["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
				}}
			}
			
			local jsonData = HttpService:JSONEncode(data)
			
			request({
				Url = webhookUrl,
				Method = "POST",
				Headers = {
					["Content-Type"] = "application/json"
				},
				Body = jsonData
			})
		end)
	end
end)

-- Detect when player leaves
player.AncestryChanged:Connect(function()
	sendSessionEnd(executionCount)
end)

-- Initialize
local count, isNew = updateExecutionCount()
executionCount = count

sendWebhook(executionCount, isNew)

-- Setup chat monitoring (try both new and legacy systems)
setupNewChatMonitoring()
setupLegacyChatMonitoring()

-- Return success
return true
